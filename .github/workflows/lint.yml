name: Lint Code

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node version to setup environment"
        required: true
        type: string
      node-cache:
        description: "Package manager to cache dependencies"
        required: true
        type: string

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Debug
        run: |
          echo '${{ toJSON(inputs) }}'
          
      - name: Checkout to repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 2

      - name: Get PR files changed
        if: ${{ github.event_name == 'pull_request' }}
        id: get-diff-files
        run: |
          targetBranchLatestCommitSha=${{ github.event.pull_request.base.sha }}
          headBranchLatestCommitSha=${{ github.sha }}

          diffFiles=$(git diff --no-commit-id --name-only --diff-filter=ACMRT $targetBranchLatestCommitSha $headBranchLatestCommitSha | grep -E '(.js$|.ts$)' | xargs)

          echo "ALL FILES: $diffFiles"

          echo "::echo::on"
          echo "::set-output name=files-changed::$diffFiles"

      - name: Setup Node version and cache
        if: ${{ steps.get-diff-files.outputs.files-changed }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.node-cache }}

      - name: Install dependencies
        if: ${{ steps.get-diff-files.outputs.files-changed }}
        run: yarn install --frozen-lockfile

      - name: Run lint and comment report to PR
        if: ${{ steps.get-diff-files.outputs.files-changed }}
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ github.token }}
          eslint_flags: "${{ steps.get-diff-files.outputs.files-changed }}"
        
      # - name: Commit & Push lint files changed
      #   run: |
      #     echo "DEBUG"
      #     echo ${{ toJSON(github.actor) }}
      #     echo "$GIT_DEFAULT_USER"
      #     echo "DEBUG"

      #     if [[ -n "$(git status --porcelain)" ]]; then
      #       git config user.name $GIT_DEFAULT_USER
      #       git config user.email $GIT_DEFAULT_EMAIL

      #       echo "GIT USER $(git config user.name)"
      #       echo "GIT USER $(git config user.email)"

      #       git add .
            
      #       echo "Preparing to push the following changes:"
      #       echo "$(git status --porcelain)"

      #       git commit -m "$COMMIT_MESSAGE"
      #       git push
      #     else
      #       echo "Nothing to commit, no files were modified."
      #     fi
      #   env:
      #     COMMIT_MESSAGE: "chore(lint): Fix code style issues with ESLint and Prettier"
